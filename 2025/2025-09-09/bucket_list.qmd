---
title: "Bucket List Map"
format: html
---

```{r}
if (!requireNamespace("pacman", quietly = TRUE)) {
  install.packages("pacman")
}

# Load required packages (install if missing)
pacman::p_load(
  tidyverse, # Data wrangling, plotting, modeling
  jsonlite, # JSON parsing
  sf, # Spatial data handling
  rnaturalearth, # Country-level shapefiles
  RColorBrewer # Color palette
)
```

```{r}
# Load Data
country_lists <- readr::read_csv(
  "https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-09-09/country_lists.csv"
)
rank_by_year <- readr::read_csv(
  "https://raw.githubusercontent.com/rfordatascience/tidytuesday/main/data/2025/2025-09-09/rank_by_year.csv"
)
```

```{r}
# Safe JSON parser to handle nested structures
# This is a custom function that safely converts JSON data into a format R can use (a tibble).
# Prevents the script from crashing if the data is messy.
safe_parse <- function(x) {
  # `tryCatch` is an error-handling function. If an error occurs, it runs the code in `error`.
  tryCatch(
    {
      # `fromJSON` from `jsonlite` converts the text into a structured R object.
      parsed <- fromJSON(x)
      # These `if` statements check the structure of the data and convert it to a `tibble`.
      if (is.data.frame(parsed)) {
        as_tibble(parsed)
      } else if (
        is.list(parsed) && length(parsed) > 0 && is.data.frame(parsed[[1]])
      ) {
        as_tibble(parsed[[1]])
      } else {
        # If no data is found, it returns an empty table (`tibble`).
        tibble()
      }
    },
    error = function(e) tibble() # If there's an error, return an empty table.
  )
}

# Columns containing nested visa data
json_cols <- c(
  "visa_required",
  "visa_online",
  "visa_on_arrival",
  "visa_free_access",
  "electronic_travel_authorisation"
)

# Parse each JSON column
country_lists_parsed <- country_lists %>%
  mutate(across(all_of(json_cols), ~ map(.x, safe_parse)))
```


```{r}
# Extract visa data for Indian passport
india <- country_lists_parsed |>
  filter(country == "India")

# Combine all visa types into one tibble
india_data <- bind_rows(
  india$visa_required[[1]] |> mutate(type = "visa_required"),
  india$visa_online[[1]] |> mutate(type = "visa_online"),
  india$visa_on_arrival[[1]] |> mutate(type = "visa_on_arrival"),
  india$visa_free_access[[1]] |> mutate(type = "visa_free_access"),
  india$electronic_travel_authorisation[[1]] |>
    mutate(type = "electronic_travel_authorisation")
)
```

```{r}
# ISO codes for bucket list destinations
my_destinations <- c("LU", "GR", "ID", "SC", "KE", "IS", "OM", "MY")

# Filter visa info for selected countries
my_visa_info <- india_data |>
  filter(code %in% my_destinations)
```

###  Prepare for Visualisation
```{r}
# Load world map
world_sf <- ne_countries(scale = "medium", returnclass = "sf") |>
  filter(
    !continent %in% c("North America", "South America", "Antarctica")
  )

# Filter bucket list countries
bucket_sf <- world_sf |>
  filter(
    name_long %in%
      c(
        "Luxembourg",
        "Greece",
        "Indonesia",
        "Seychelles",
        "Kenya",
        "Iceland",
        "Oman",
        "Malaysia"
      )
  )
```

```{r}
# Join visa info with spatial data
# Join the 'iso_a2' column from the map data with the 'code' column from your visa info.
bucket_sf_with_visa <- bucket_sf |>
  left_join(
    my_visa_info,
    by = c("iso_a2" = "code"),
    suffix = c("_map", "_visa")
  )
```

```{r}
# Create Custom theme
custom_theme <- theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title.position = "top",
    legend.title = element_text(size = 14, hjust = 0.5),
    legend.text = element_text(size = 12),
    text = element_text(family = "Verdana"), # Global Verdana font
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.title = element_blank(),
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    plot.title = element_text(
      size = 17,
      face = "bold",
      hjust = 0.5,
      margin = margin(t = 20, b = 10)
    ),
    plot.subtitle = element_text(
      size = 15,
      hjust = 0.5
    ),
    plot.caption = element_text(
      size = 12,
      hjust = 0.5,
      margin = margin(t = 10, b = 20)
    )
  )

# Creates a custom palette
## Select five distinct colors from the Set2 palette for visa categories
custom_palette <- brewer.pal(n = 8, name = "Set2")[2:6] #
```

### Map
```{r}
# Create map
ggplot() +
  geom_sf(data = world_sf, fill = "wheat", color = "snow1", linewidth = 0.25) +
  geom_sf(
    data = bucket_sf_with_visa,
    aes(fill = type_visa),
    color = "rosybrown",
    linewidth = 0.75
  ) +
  geom_sf_text(
    data = bucket_sf_with_visa,
    aes(label = name_long),
    fontface = "bold",
    family = "Verdana",
    color = "grey4",
    size = 4,
    nudge_y = -5.2
  ) +
  scale_fill_manual(
    name = "Visa Requirement (Indian Passport)",
    # Assign the Set2 colors to each category
    values = c(
      "visa_free_access" = custom_palette[1],
      "visa_online" = custom_palette[2],
      "visa_on_arrival" = custom_palette[3],
      "visa_required" = custom_palette[4],
      "electronic_travel_authorisation" = custom_palette[5]
    ),
    labels = c(
      "visa_free_access" = "Visa Free Access",
      "visa_online" = "Visa Online",
      "visa_on_arrival" = "Visa on Arrival",
      "visa_required" = "Visa Required",
      "electronic_travel_authorisation" = "Electronic Travel Authorisation"
    )
  ) +
  coord_sf(xlim = c(-30, 150), ylim = c(-55, 80), expand = FALSE) +
  labs(
    title = "Please, Do Not Jinx My Bucket List",
    subtitle = "A lazy blob maintaining a list inspired by an obnoxious number of travel vlogs",
    caption = "Data: Henley Passport Index API | Visualization: Darakhshan Nehal"
  ) +
  custom_theme
```

```{r}
# Save plot
ggsave(
  filename = "bucket_list_map.png",
  width = 9.5, #  Width in inches
  height = 8, #  Height in inches
  dpi = 300, #  For High-resolution
  bg = "white" # Ensures white background, as theme_minimal() uses a transparent background by default
)
```
